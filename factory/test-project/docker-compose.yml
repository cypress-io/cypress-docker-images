version: '3'

services:
  args-defined:
    build:
      dockerfile: argsDefined.Dockerfile
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
    command: npm run test
  ## factory
  test-factory-electron:
    build:
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
    command: npm run test
  # Installs Node and Chrome
  test-factory-chrome:
    build:
      args:
        CHROME_VERSION: ${CHROME_VERSION}
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
      context: .
    command: npm run test -- -b chrome
  # Installs Node and Firefox
  test-factory-firefox:
    build:
      args:
        FIREFOX_VERSION: ${FIREFOX_VERSION}
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
      context: .
    command: npm run test -- -b firefox
  # Installs Node and Edge
  test-factory-edge:
    build:
      args:
        EDGE_VERSION: ${EDGE_VERSION}
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
      context: .
    command: npm run test -- -b edge
  # Doesn't npm install the local cypress version, builds with cypress 10, tests will fail.
  test-factory-cypress-included-electron:
    env_file: ../.env
    build:
      args:
        CYPRESS_VERSION: ${CYPRESS_VERSION}
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
      dockerfile: noNPMInstall.Dockerfile
      context: .
    command: cypress run
  test-factory-cypress-included-chrome:
    env_file: ../.env
    build:
      args:
        CYPRESS_VERSION: ${CYPRESS_VERSION}
        CHROME_VERSION: ${CHROME_VERSION}
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
      dockerfile: noNPMInstall.Dockerfile
      context: .
    command: cypress run -b chrome
  test-factory-cypress-included-firefox:
    env_file: ../.env
    build:
      args:
        CYPRESS_VERSION: ${CYPRESS_VERSION}
        FIREFOX_VERSION: ${FIREFOX_VERSION}
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
      dockerfile: noNPMInstall.Dockerfile
      context: .
    command: cypress run -b firefox
  test-factory-cypress-included-edge:
    env_file: ../.env
    build:
      args:
        CYPRESS_VERSION: ${CYPRESS_VERSION}
        EDGE_VERSION: ${EDGE_VERSION}
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
      dockerfile: noNPMInstall.Dockerfile
      context: .
    command: cypress run -b edge
  test-factory-all-included:
    env_file: ../.env
    build:
      args:
        YARN_VERSION: ${YARN_VERSION}
        CYPRESS_VERSION: ${CYPRESS_VERSION}
        CHROME_VERSION: ${CHROME_VERSION}
        FIREFOX_VERSION: ${FIREFOX_VERSION}
        EDGE_VERSION: ${EDGE_VERSION}
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
      dockerfile: noNPMInstall.Dockerfile
      context: .
    command: sh -c "cypress run && cypress run -b chrome && cypress run -b edge && cypress run -b firefox"
  test-factory-all-included-electron-only:
    env_file: ../.env
    build:
      args:
        YARN_VERSION: ${YARN_VERSION}
        CYPRESS_VERSION: ${CYPRESS_VERSION}
        CHROME_VERSION: ${CHROME_VERSION}
        FIREFOX_VERSION: ${FIREFOX_VERSION}
        EDGE_VERSION: ${EDGE_VERSION}
        BASE_FACTORY_IMAGE: cypress/factory:${FACTORY_VERSION}
      dockerfile: noNPMInstall.Dockerfile
      context: .
    command: cypress run
## base
  test-base:
    build:
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/base:${NODE_VERSION}
    command: npm run test
## browsers
  test-browsers-electron:
    build:
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/browsers:node-${NODE_VERSION}-chrome-${CHROME_VERSION}-ff-${FIREFOX_VERSION}-edge-${EDGE_VERSION}
    command: npm run test
  test-browsers-chrome:
    build:
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/browsers:node-${NODE_VERSION}-chrome-${CHROME_VERSION}-ff-${FIREFOX_VERSION}-edge-${EDGE_VERSION}
    command: npm run test -- -b chrome
  test-browsers-firefox:
    build:
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/browsers:node-${NODE_VERSION}-chrome-${CHROME_VERSION}-ff-${FIREFOX_VERSION}-edge-${EDGE_VERSION}
    command: npm run test -- -b firefox
  test-browsers-edge:
    build:
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/browsers:node-${NODE_VERSION}-chrome-${CHROME_VERSION}-ff-${FIREFOX_VERSION}-edge-${EDGE_VERSION}
    command: npm run test -- -b edge
## Included
  test-included-electron:
    build:
      dockerfile: included.Dockerfile
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/included:${CYPRESS_VERSION}
    command: cypress run
  test-included-chrome:
    build:
      dockerfile: included.Dockerfile
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/included:${CYPRESS_VERSION}
    command: cypress run -b chrome
  test-included-firefox:
    build:
      dockerfile: included.Dockerfile
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/included:${CYPRESS_VERSION}
    command: cypress run -b firefox
  test-included-edge:
    build:
      dockerfile: included.Dockerfile
      context: .
      args:
        BASE_FACTORY_IMAGE: cypress/included:${CYPRESS_VERSION}
    command: cypress run -b edge
